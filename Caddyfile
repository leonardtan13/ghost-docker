{
    auto_https off
}

:8080 {
    # ActivityPub routes
    handle /.ghost/activitypub/* {
        uri strip_suffix /
        reverse_proxy activitypub:8080 {
            header_up Host blog.leonardtgm.com
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host blog.leonardtgm.com
        }
    }

    handle /.well-known/webfinger {
        reverse_proxy activitypub:8080 {
            header_up Host blog.leonardtgm.com
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host blog.leonardtgm.com
        }
    }

    handle /.well-known/nodeinfo {
        reverse_proxy activitypub:8080 {
            header_up Host blog.leonardtgm.com
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host blog.leonardtgm.com
        }
    }

    handle /nodeinfo/* {
        reverse_proxy activitypub:8080 {
            header_up Host blog.leonardtgm.com
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host blog.leonardtgm.com
        }
    }

    # Analytics routes (traffic-analytics proxy)
    handle /.ghost/analytics/* {
        uri strip_prefix /.ghost/analytics
        reverse_proxy traffic-analytics:3000 {
            header_up Host blog.leonardtgm.com
            header_up X-Forwarded-Proto https
        }
    }

    # JWKS endpoint for ActivityPub handshake
    handle /ghost/.well-known/jwks.json {
        reverse_proxy ghost:2368 {
            header_up X-Forwarded-Proto https
        }
    }

    # All other traffic goes to Ghost
    handle {
        reverse_proxy ghost:2368 {
            header_up X-Forwarded-Proto https
        }
    }
}
