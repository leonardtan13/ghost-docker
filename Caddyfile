{
    auto_https off
}

:8080 {
    # ActivityPub routes
    handle /.ghost/activitypub/* {
        reverse_proxy activitypub:8080 {
            header_up X-Forwarded-Proto https
        }
    }

    handle /.well-known/webfinger {
        reverse_proxy activitypub:8080 {
            header_up X-Forwarded-Proto https
        }
    }

    handle /.well-known/nodeinfo {
        reverse_proxy activitypub:8080 {
            header_up X-Forwarded-Proto https
        }
    }

    handle /nodeinfo/* {
        reverse_proxy activitypub:8080 {
            header_up X-Forwarded-Proto https
        }
    }

    # JWKS endpoint for ActivityPub handshake
    handle /ghost/.well-known/jwks.json {
        reverse_proxy ghost:2368 {
            header_up X-Forwarded-Proto https
        }
    }

    # All other traffic goes to Ghost
    handle {
        reverse_proxy ghost:2368 {
            header_up X-Forwarded-Proto https
        }
    }
}
